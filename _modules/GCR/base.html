
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GCR.base &#8212; Generic Catalog Reader (GCR) 0.9.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for GCR.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains the base class for a generic catalog (BaseGenericCatalog).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">GCRQuery</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">is_string_like</span><span class="p">,</span> <span class="n">trivial_callable</span><span class="p">,</span> <span class="n">concatenate_1d</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BaseGenericCatalog&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="BaseGenericCatalog"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog">[docs]</a><span class="k">class</span> <span class="nc">BaseGenericCatalog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for all catalog classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_required_attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">_required_quantities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">_default_quantity_modifier</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_quantity_modifiers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">_native_quantities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">_native_filter_quantities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">native_filter_string_only</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subclass_init</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_native_quantities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_native_quantity_list</span><span class="p">())</span>

        <span class="c1"># enforce the existence of required attributes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_attributes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Any subclass of BaseGenericCatalog must implement following attributes: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_required_attributes</span><span class="p">)))</span>

        <span class="c1"># enforce the minimal set of quantities</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_quantities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_required_quantities</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Catalog must have the following quantities: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_required_quantities</span><span class="p">))</span>

        <span class="c1"># to check if all native quantities in the modifiers are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_quantities_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_all_quantities</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="BaseGenericCatalog.get_quantities"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.get_quantities">[docs]</a>    <span class="k">def</span> <span class="nf">get_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantities</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">native_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_iterator</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch quantities from this catalog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        quantities : str or list of str or tuple of str</span>
<span class="sd">            quantities to fetch</span>

<span class="sd">        filters : list of tuple, or GCRQuery instance, optional</span>
<span class="sd">            filters to apply. Each filter should be in the format of (callable, str, str, ...)</span>

<span class="sd">        native_filters : list of tuple, optional</span>
<span class="sd">            Native filters to apply. Each filter should be in the format of (callable, str, str, ...)</span>

<span class="sd">        return_iterator : bool, optional</span>
<span class="sd">            if True, return an iterator that iterates over the native format, default is False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        quantities : dict, or iterator of dict (when `return_iterator` is True)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">quantities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_requested_quantities</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_filters</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">native_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_native_filters</span><span class="p">(</span><span class="n">native_filters</span><span class="p">)</span>

        <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantities_iter</span><span class="p">(</span><span class="n">quantities</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">native_filters</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_iterator</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">it</span>

        <span class="n">data_all</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantities</span><span class="p">:</span>
                <span class="n">data_all</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">q</span><span class="p">:</span> <span class="n">concatenate_1d</span><span class="p">(</span><span class="n">data_all</span><span class="p">[</span><span class="n">q</span><span class="p">])</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantities</span><span class="p">}</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.has_quantity"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.has_quantity">[docs]</a>    <span class="k">def</span> <span class="nf">has_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">include_native</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if *quantity* is available in this catalog</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        quantity : str</span>
<span class="sd">            a quantity name to check</span>

<span class="sd">        include_native : bool, optional</span>
<span class="sd">            whether or not to include native quantity names when checking</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        has_quantity : bool</span>
<span class="sd">            True if the quantities are all available; otherwise False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">include_native</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_native_quantities</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_quantities</span><span class="p">({</span><span class="n">quantity</span><span class="p">}))</span>

        <span class="k">return</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.has_quantities"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.has_quantities">[docs]</a>    <span class="k">def</span> <span class="nf">has_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantities</span><span class="p">,</span> <span class="n">include_native</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if ALL *quantities* specified are available in this catalog</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        quantities : iterable</span>
<span class="sd">            a list of quantity names to check</span>

<span class="sd">        include_native : bool, optional</span>
<span class="sd">            whether or not to include native quantity names when checking</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        has_quantities : bool</span>
<span class="sd">            True if the quantities are all available; otherwise False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">quantities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_native</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_native_quantities</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_quantities</span><span class="p">(</span><span class="n">quantities</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantities</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.list_all_quantities"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.list_all_quantities">[docs]</a>    <span class="k">def</span> <span class="nf">list_all_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_native</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of all available quantities in this catalog.</span>

<span class="sd">        If *include_native* is `True`, includes native quantities.</span>
<span class="sd">        If *with_info* is `True`, return a dict with quantity info.</span>

<span class="sd">        See also: list_all_native_quantities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_native</span><span class="p">:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_native_quantities</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quantity_info</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">q</span><span class="p">}</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">q</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.list_all_native_quantities"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.list_all_native_quantities">[docs]</a>    <span class="k">def</span> <span class="nf">list_all_native_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of all available native quantities in this catalog.</span>

<span class="sd">        If *with_info* is `True`, return a dict with quantity info.</span>

<span class="sd">        See also: list_all_quantities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_native_quantities</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quantity_info</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">q</span><span class="p">}</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">q</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.first_available"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.first_available">[docs]</a>    <span class="k">def</span> <span class="nf">first_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">quantities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the first available quantity in the input arguments.</span>
<span class="sd">        Return `None` if none of them is available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">quantities</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_quantity</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not available; using </span><span class="si">{}</span><span class="s1"> instead&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quantities</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">q</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.get_input_kwargs"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.get_input_kwargs">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deprecated. Use `get_catalog_info` instead.</span>

<span class="sd">        Get information from the catalog config file.</span>
<span class="sd">        If *key* is `None`, return the full dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;`get_input_kwargs` is deprecated; use `get_catalog_info` instead.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_catalog_info</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.get_catalog_info"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.get_catalog_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_catalog_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get information from the catalog config file.</span>
<span class="sd">        If *key* is `None`, return the full dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_kwargs</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.get_quantity_info"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.get_quantity_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_quantity_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get information of a certain quantity.</span>
<span class="sd">        If *key* is `None`, return the full dict for that quantity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantity_info_dict</span><span class="p">(</span><span class="n">quantity</span><span class="p">,</span> <span class="n">default</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span>

        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.add_quantity_modifier"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.add_quantity_modifier">[docs]</a>    <span class="k">def</span> <span class="nf">add_quantity_modifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">modifier</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a quantify modifier.</span>
<span class="sd">        Consider useing the high-level function `add_derived_quantity` instead!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        quantity : str</span>
<span class="sd">            name of the derived quantity to add</span>

<span class="sd">        modifier : None or str or tuple</span>
<span class="sd">            If the quantity modifier is a tuple of length &gt;=2 and the first element is a callable,</span>
<span class="sd">            it should be in the formate of `(callable, native quantity 1,  native quantity 2, ...)`.</span>
<span class="sd">            And the modifier would work as callable(native quantity 1,  native quantity 2, ...)</span>
<span class="sd">            If the quantity modifier is None, the quantity will be used as the native quantity name</span>
<span class="sd">            Otherwise, the modifier would be use directly as a native quantity name</span>

<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If False and quantity are already specified in _quantity_modifiers, raise an ValueError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;quantity `</span><span class="si">{}</span><span class="s1">` already exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quantity</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span><span class="p">[</span><span class="n">quantity</span><span class="p">]</span> <span class="o">=</span> <span class="n">modifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_quantities_exist</span><span class="p">([</span><span class="n">quantity</span><span class="p">],</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.get_quantity_modifier"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.get_quantity_modifier">[docs]</a>    <span class="k">def</span> <span class="nf">get_quantity_modifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrive a quantify modifier.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        quantity : str</span>
<span class="sd">            name of the derived quantity to get</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        quantity_modifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quantity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_quantity_modifier</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.get_normalized_quantity_modifier"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.get_normalized_quantity_modifier">[docs]</a>    <span class="k">def</span> <span class="nf">get_normalized_quantity_modifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrive a quantify modifier, normalized.</span>
<span class="sd">        This function would also return a tuple, with the first item a callable,</span>
<span class="sd">        and the rest native quantity names</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        quantity : str</span>
<span class="sd">            name of the derived quantity to get</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple : (callable, quantity1, quantity2...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">modifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quantity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_quantity_modifier</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">trivial_callable</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">modifier</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">modifier</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modifier</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">modifier</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">modifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">modifier</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">trivial_callable</span><span class="p">,</span> <span class="n">modifier</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.add_derived_quantity"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.add_derived_quantity">[docs]</a>    <span class="k">def</span> <span class="nf">add_derived_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">derived_quantity</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">quantities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a derived quantify modifier.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        derived_quantity : str</span>
<span class="sd">            name of the derived quantity to be added</span>

<span class="sd">        func : callable</span>
<span class="sd">            function to calculate the derived quantity</span>
<span class="sd">            the number of arguments should equal number of following `quantities`</span>

<span class="sd">        quantities : list of str</span>
<span class="sd">            quantities to pass to the callable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">derived_quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;quantity name `</span><span class="si">{}</span><span class="s1">` already exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">derived_quantity</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_native_quantities</span><span class="p">):</span>
            <span class="n">new_modifier</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">,)</span> <span class="o">+</span> <span class="n">quantities</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">quantities_needed</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">quantity_count</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantities</span><span class="p">:</span>
                <span class="n">modifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_normalized_quantity_modifier</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="n">functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modifier</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">quantities_needed</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">modifier</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">quantity_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modifier</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">_new_func</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">quantity_count</span><span class="p">)</span>
                <span class="n">count_current</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">func_this</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">quantity_count</span><span class="p">):</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_this</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">count_current</span><span class="p">:(</span><span class="n">count_current</span> <span class="o">+</span> <span class="n">count</span><span class="p">)]))</span>
                    <span class="n">count_current</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">new_args</span><span class="p">)</span>

            <span class="n">new_modifier</span> <span class="o">=</span> <span class="p">(</span><span class="n">_new_func</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">quantities_needed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_quantity_modifier</span><span class="p">(</span><span class="n">derived_quantity</span><span class="p">,</span> <span class="n">new_modifier</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.add_modifier_on_derived_quantities"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.add_modifier_on_derived_quantities">[docs]</a>    <span class="k">def</span> <span class="nf">add_modifier_on_derived_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_quantity</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">quantities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deprecated. Use `add_derived_quantity` instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Use `add_derived_quantity` instead.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_derived_quantity</span><span class="p">(</span><span class="n">new_quantity</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">quantities</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseGenericCatalog.del_quantity_modifier"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog.del_quantity_modifier">[docs]</a>    <span class="k">def</span> <span class="nf">del_quantity_modifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a quantify modifier.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        quantity : str</span>
<span class="sd">            name of the derived quantity to delete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span><span class="p">[</span><span class="n">quantity</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">native_filter_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        quantities that can be used in native filters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_native_filter_quantities</span><span class="p">)</span>

<div class="viewcode-block" id="BaseGenericCatalog._get_quantity_info_dict"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog._get_quantity_info_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_get_quantity_info_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be implemented by subclass.</span>
<span class="sd">        Must return a dictionary for existing quantity.</span>
<span class="sd">        For non-existing quantity must return default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">default</span></div>

    <span class="k">def</span> <span class="nf">_translate_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity_requested</span><span class="p">,</span> <span class="n">native_quantities_needed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">native_quantities_needed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">native_quantities_needed</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="n">modifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quantity_requested</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_quantity_modifier</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">modifier</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">callable</span><span class="p">(</span><span class="n">modifier</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">native_quantities_needed</span><span class="p">[</span><span class="n">quantity_requested</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quantity_requested</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modifier</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">modifier</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">modifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">native_quantity</span> <span class="ow">in</span> <span class="n">modifier</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">native_quantities_needed</span><span class="p">[</span><span class="n">native_quantity</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quantity_requested</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">native_quantities_needed</span><span class="p">[</span><span class="n">modifier</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quantity_requested</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">native_quantities_needed</span>

    <span class="k">def</span> <span class="nf">_translate_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantities_requested</span><span class="p">):</span>
        <span class="n">native_quantities_needed</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantities_requested</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_translate_quantity</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">native_quantities_needed</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">native_quantities_needed</span>

    <span class="k">def</span> <span class="nf">_check_quantities_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantities_requested</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">native_quantity</span><span class="p">,</span> <span class="n">quantities</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_quantities</span><span class="p">(</span><span class="n">quantities_requested</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">native_quantity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_native_quantities</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Native quantity `</span><span class="si">{}</span><span class="s1">` does not exist (required by `</span><span class="si">{}</span><span class="s1">`)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">native_quantity</span><span class="p">,</span> <span class="s1">&#39;`, `&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">quantities</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_preprocess_requested_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantities</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_string_like</span><span class="p">(</span><span class="n">quantities</span><span class="p">):</span>
            <span class="n">quantities</span> <span class="o">=</span> <span class="p">{</span><span class="n">quantities</span><span class="p">}</span>

        <span class="n">quantities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quantities</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must set `quantities`.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_quantities_exist</span><span class="p">(</span><span class="n">quantities</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">quantities</span>

    <span class="k">def</span> <span class="nf">_preprocess_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">GCRQuery</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="n">GCRQuery</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">is_string_like</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="n">GCRQuery</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="n">GCRQuery</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_quantities_exist</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">variable_names</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filters</span>

    <span class="k">def</span> <span class="nf">_preprocess_native_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">native_filters</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">native_filter_string_only</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">native_filters</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">is_string_like</span><span class="p">(</span><span class="n">native_filters</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">native_filters</span><span class="p">,)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">is_string_like</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">native_filters</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`native_filters` is not set correctly. Must be None or a list of strings.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">native_filters</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">native_filters</span><span class="p">,</span> <span class="n">GCRQuery</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">native_filters</span><span class="p">:</span>
            <span class="n">native_filters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">is_string_like</span><span class="p">(</span><span class="n">native_filters</span><span class="p">):</span>
            <span class="n">native_filters</span> <span class="o">=</span> <span class="n">GCRQuery</span><span class="p">(</span><span class="n">native_filters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">native_filters</span> <span class="o">=</span> <span class="n">GCRQuery</span><span class="p">(</span><span class="o">*</span><span class="n">native_filters</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">native_filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">native_filters</span><span class="o">.</span><span class="n">variable_names</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_native_filter_quantities</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not all quantities in `native_filters` can be used in native filters!&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">native_filters</span>

    <span class="k">def</span> <span class="nf">_assemble_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity_requested</span><span class="p">,</span> <span class="n">native_quantities_loaded</span><span class="p">):</span>
        <span class="n">modifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantity_modifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quantity_requested</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_quantity_modifier</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">modifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">native_quantities_loaded</span><span class="p">[</span><span class="n">quantity_requested</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">modifier</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">modifier</span><span class="p">(</span><span class="n">native_quantities_loaded</span><span class="p">[</span><span class="n">quantity_requested</span><span class="p">])</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modifier</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">modifier</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">modifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">modifier</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="o">*</span><span class="p">(</span><span class="n">native_quantities_loaded</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">modifier</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="k">return</span> <span class="n">native_quantities_loaded</span><span class="p">[</span><span class="n">modifier</span><span class="p">]</span>

<div class="viewcode-block" id="BaseGenericCatalog._obtain_native_data_dict"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog._obtain_native_data_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_obtain_native_data_dict</span><span class="p">(</span><span class="n">native_quantities_needed</span><span class="p">,</span> <span class="n">native_quantity_getter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method can be overwritten if `native_quantity_getter` has a</span>
<span class="sd">        different behavior, for example, if `native_quantity_getter` can</span>
<span class="sd">        retrive multiple quantities at once, this method can return</span>
<span class="sd">        ```python</span>
<span class="sd">        dict(zip(native_quantities_needed, native_quantity_getter(native_quantities_needed)))</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">q</span><span class="p">:</span> <span class="n">native_quantity_getter</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">native_quantities_needed</span><span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">_load_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantities</span><span class="p">,</span> <span class="n">native_quantity_getter</span><span class="p">):</span>
        <span class="n">native_quantities_needed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_quantities</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span>
        <span class="n">native_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obtain_native_data_dict</span><span class="p">(</span><span class="n">native_quantities_needed</span><span class="p">,</span> <span class="n">native_quantity_getter</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">q</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_quantity</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">native_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantities</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_quantities_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantities</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">native_filters</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">native_quantity_getter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_native_dataset</span><span class="p">(</span><span class="n">native_filters</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_quantities</span><span class="p">(</span><span class="n">quantities</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">variable_names</span><span class="p">)),</span>
                                         <span class="n">native_quantity_getter</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">quantities</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">data</span>
            <span class="k">del</span> <span class="n">data</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quantities</span><span class="p">([</span><span class="n">key</span><span class="p">])[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_native_quantities</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

<div class="viewcode-block" id="BaseGenericCatalog._subclass_init"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog._subclass_init">[docs]</a>    <span class="k">def</span> <span class="nf">_subclass_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be implemented by subclass.</span>
<span class="sd">        Must return `None`.</span>
<span class="sd">        Must accept any keyword argument (i.e., must have **kwargs).</span>
<span class="sd">        This method is called during __init__().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="BaseGenericCatalog._generate_native_quantity_list"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog._generate_native_quantity_list">[docs]</a>    <span class="k">def</span> <span class="nf">_generate_native_quantity_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be implemented by subclass.</span>
<span class="sd">        Must return an iterable of all native quantity names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="BaseGenericCatalog._iter_native_dataset"><a class="viewcode-back" href="../../index.html#GCR.BaseGenericCatalog._iter_native_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">_iter_native_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">native_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be implemented by subclass.</span>
<span class="sd">        Must be a generator.</span>
<span class="sd">        Must yield a callable, *native_quantity_getter*.</span>
<span class="sd">        This function must iterate over subsets of rows, not columns!</span>

<span class="sd">        *native_filters* will either be `None` or a `GCRQuery` object</span>
<span class="sd">        (unless `self.native_filter_string_only` is set to True, in which</span>
<span class="sd">        case *native_filters* will either be `None` or a tuple of strings).</span>
<span class="sd">        If *native_filters* is a GCRQuery object, you can use</span>
<span class="sd">        `native_filters.check_scalar(scalar_dict)` to check if `scalar_dict`</span>
<span class="sd">        satisfies `native_filters`.</span>

<span class="sd">        Below are specifications of *native_quantity_getter*</span>
<span class="sd">        -----------------------------------------</span>
<span class="sd">        Must take a single argument of a native quantity name</span>
<span class="sd">        (unless `_obtain_native_data_dict` is edited accordingly)</span>
<span class="sd">        Should assume the argument is valid.</span>
<span class="sd">        Must return a numpy 1d array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Generic Catalog Reader (GCR)</a></h1>









<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017-2018, Yao-Yuan Mao.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>